{% extends 'project.html' %}
{% load staticfiles %}
{% block title %}
    {% if project %}
        {{ project.heading }} - Bearbeiten
    {% else %}
        Neues Projekt erstellen
    {% endif %}
{% endblock %}
{% block css %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css">
    <link rel="stylesheet" href="{% static 'style/libs/dropzone.min.css' %}">
    <style>
        .dz-details {
            display: none !important;
        }

        .dz-progress {
            display: none !important;
        }
    </style>
{% endblock %}
{% block id %}
    projectupload-area
{% endblock %}
{% block imagespace %}
    <div class="upload-title-image-wrapper">
        <a class="text-center text-primary" data-toggle="modal" data-target="#imgUploadModal">
            <span class="fa fa-upload fa-4x" style="padding-top:22%;"></span><br>
            <span style="display:inline-block;">Titelbild hochladen</span>
        </a>
    </div>

    {% include 'upload/imguploadmodal.html' %}
{% endblock %}

{% block maininfo %}
    <input type="text" id="heading" class="form-control input-lg h1 font-elegance" placeholder="Titel" maxlength="40"
            {% if project %} value="{{ project.heading }}" {% endif %}>
    <input type="text" id="subheading" class="form-control input-sm h4 font-elegance" placeholder="Untertitel"
           maxlength="70"
            {% if project %} value="{{ project.subheading }}" {% endif %}>
    <hr>
    <div class="input-group">
        <textarea id="description" class="form-control resize-none" placeholder="Kurzbeschreibung" rows="5"
                  maxlength="500">{% if project %}{{ project.description }}{% endif %}</textarea>
    </div>
{% endblock %}

{% block contentbody %}
    <div id="content-body">
        <div id="content-btn">
            {% include 'upload/addcontent.html' %}
        </div>
    </div>
{% endblock %}

{% block projectsocials %}
    <div class="psocial col-xs-12 col-sm-4 col-md-4 col-lg-4 text-center">
        <a id="link1">
            <p class="btn btn-primary btn-lg"><i class="fa fa-plus"></i></p>
            <br>
            Link hinzufügen
        </a>
        <div class="hidden">
            <label>Link eingeben</label>
            <img class="link-close" width="12px" style="margin-left:8px; cursor: pointer;"
                 src="{% static 'images/x.svg' %}">
            <input type="text" class="form-control input-sm h4 font-elegance"/>
        </div>
    </div>
    <div class="psocial col-xs-12 col-sm-4 col-md-4 col-lg-4 text-center">
        <a id="link2">
            <p class="btn btn-primary btn-lg"><i class="fa fa-plus"></i></p>
            <br>
            Link hinzufügen
        </a>
        <div class="hidden">
            <label>Link eingeben</label>
            <img class="link-close" width="12px" style="margin-left:8px; cursor: pointer;"
                 src="{% static 'images/x.svg' %}">
            <input type="text" class="form-control input-sm h4 font-elegance"/>
        </div>
    </div>
    <div class="psocial col-xs-12 col-sm-4 col-md-4 col-lg-4 text-center">
        <a id="link3">
            <p class="btn btn-primary btn-lg"><i class="fa fa-plus"></i></p>
            <br>
            Link hinzufügen
        </a>
        <div class="hidden">
            <label>Link eingeben</label>
            <img class="link-close" width="12px" style="margin-left:8px; cursor: pointer;"
                 src="{% static 'images/x.svg' %}">
            <input type="text" class="form-control input-sm h4 font-elegance"/>
        </div>
    </div>
{% endblock %}

{% block projectmember %}
    <div id="member-wrapper">
        {{ request.user.get_lib_user.get_public_name }}
        <ul id="resp-bar-{{ request.user.get_lib_user.id }}" style="border: 1px solid #e6e6e6;">
        </ul>
    </div>
    <hr>
    <button class="btn btn-primary btn-block" id="pu-add-member">Mitglied hinzufügen</button>
    <hr>
    <div id="supervisor-wrapper">
    </div>
    <button class="btn btn-primary btn-block" id="pu-add-supervisor">Betreuer hinzufügen</button>

{% endblock %}

{% block projectinfo %}
    <div class="form-group">
        <label for="degreeprogram-select">Studiengang</label>
        <select id="degreeprogram-select" class="form-control">{% for d_p in degree_programs %}
            <option value="{{ d_p.id }}">{{ d_p.name }}</option>{% endfor %}</select>
    </div>
    <div class="form-group">
        <label for="subject-select">Fach</label>
        <select class="form-control" id="subject-select"></select>
    </div>
    <div class="form-group">
        <label for="semesteryear-select">Semester</label>
        <select id="semesteryear-select" class="form-control">{% for i in year_choices %}
            <option value="WS{{ i }}" {% if  forloop.counter0 == 0 %}selected{% endif %}>
                WiSe {{ i }}/{{ i|add:1 }}</option>
            <option value="SS{{ i }}">SoSe {{ i }}</option>
        {% endfor %}</select>
    </div>
{% endblock %}

{% block tags %}
    <ul id="add-tags-bar" style="border: 1px solid #e6e6e6;">
    </ul>
{% endblock %}

{% block metadatabox %}
    <div class="panel">
        <div class="panel-body row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6" style="padding-right:4px;">
                <button class="btn btn-primary btn-block">Speichern</button>
            </div>
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6" style="padding-left:4px;">
                <button class="btn btn-secondary btn-block">Verwerfen</button>
            </div>
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <button class="btn btn-danger btn-block" id="pu-publish">Veröffentlichen</button>
            </div>
        </div>
    </div>
{% endblock %}
{% block scripts %}
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/jquery-ui.min.js" type="text/javascript"
            charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.full.min.js"></script>
    <script src="{% static 'js/libs/dropzone.min.js' %}" type="text/javascript"></script>
    <script src="{% static 'search/js/tag-it.js' %}" type="text/javascript" charset="utf-8"></script>
    <script src="{% static 'upload/js/upload.js' %}" type="text/javascript" charset="utf-8"></script>
    <script src="{% static 'js/libs/bootstrap-filestyle.min.js' %}" type="text/javascript" charset="utf-8"></script>

    <script>
        var addcontentchoice;
        var addcontent;
        var supervisor_wrapper = $('#supervisor-wrapper');
        var supervisor_input_uid = 0;
        var member_wrapper = $('#member-wrapper');
        var users_responsibilities = {};
        var content_btn = $('#content-btn');
        var $body = $('body');

        content_btn.on("click", "#addText", function () {
            $.getJSON("{% url 'add-content' content_type='text' %}", function (json) {
                content_btn.before(json.text);
            });
        });

        $body.on("click", "#addSoundcloudLink", function () {
            var soundcloud_input = $('#soundcloud-input');
            soundcloud_input
                .clone()
                .removeAttr("id")
                .addClass("soundcloud-input")
                .removeClass("hidden")
                .appendTo(soundcloud_input.siblings('.audio-input-container'));
        });

        $body.on("click", "#addAudioFile", function () {
            var audio_file_input = $('#audio-file-input');
            audio_file_input
                .clone()
                .removeAttr("id")
                .addClass("audio-input")
                .removeClass("hidden")
                .appendTo(audio_file_input.siblings('.audio-input-container'));
            $(".audio-input").find(":file").filestyle({
                buttonText: "",
                buttonName: "btn-primary",
                iconName: "fa fa-file-audio-o",
                buttonBefore: true,
                placeholder: "Keine Datei ausgewählt."
            });
        });

        $body.on("click", ".soundcloud-close", function () {
            $(this).parent().remove();
        });
        $body.on("click", ".audiofile-close", function () {
            $(this).parent().remove();
        });

        content_btn.on("click", "#addSlideshow", function () {
            $.getJSON("{% url 'add-content' content_type='slideshow' %}", function (json) {
                content_btn.before(json.text);
                $('.add-content-slideshow').last().find('form').dropzone({
                    url: "{% url 'new-project' %}",
                    addRemoveLinks: true,
                    dictDefaultMessage: "Füge ein oder mehrere Bilder hinzu.",
                    dictRemoveFile: "Entfernen",
                    acceptedFiles: 'image/*',
                    // referring to https://github.com/enyo/dropzone/wiki/Combine-normal-form-with-Dropzone
                    autoProcessQueue: false,
                    uploadMultiple: true,
                    parallelUploads: 100,
                    maxFiles: 10,
                    init: function () {
                        this.on("error", function (file, errMsg, xhr) {
                            if (!xhr) {
                                if (!file.accepted) this.removeFile(file);
                            } else {
                                var json = JSON.parse(xhr.responseText);
                                // TODO: render errors
                            }
                        });
                        this.on("successmultiple", function (files, response) {
                            window.location = response.redirect;
                            console.log("success dropzone submit + json");
                        });
                    }
                });
            });
        });

        content_btn.on("click", "#addAudio", function () {
            $.getJSON("{% url 'add-content' content_type='audio' %}", function (json) {
                content_btn.before(json.text);
            });
        });

        content_btn.on("click", "#addVideo", function () {
            $.getJSON("{% url 'add-content' content_type='video' %}", function (json) {
                content_btn.before(json.text);
            });
        });

        $body.on("click", "#addVideoFile", function () {
            var video_input = $('#vidoe-file-input');
            video_input
                .clone()
                .removeAttr("id")
                .addClass("video-input")
                .removeClass("hidden")
                .appendTo(video_input.siblings('.video-input-container'));
            $(".video-input").find(":file").filestyle({
                buttonText: "",
                buttonName: "btn-primary",
                iconName: "fa fa-file-video-o",
                buttonBefore: true,
                placeholder: "Keine Datei ausgewählt."
            });
        });
        $body.on("click", ".videofile-close", function () {
            $(this).parent().remove();
        });

        $body.on("click", ".addVideoLink", function () {
            var video_link = $('#video-link-input');
            video_link
                .clone()
                .removeAttr("id")
                .addClass("video-link-input")
                .removeClass("hidden")
                .appendTo(video_link.siblings('.video-input-container'));
        });

        $body.on("click", ".video-link-close", function () {
            $(this).parent().remove();
        });


        content_btn.on("mouseenter", "#addcontent-row", function () {
            $(this).replaceWith(addcontentchoice);
        });

        content_btn.on("mouseleave", "#addcontentchoice-row", function () {
            $(this).replaceWith(addcontent);
        });


        $('#degreeprogram-select').change(function () {
            var id = $(this).val();
            $.ajax({
                url: "/subjects_by_degree_program/" + id,
                dataType: 'json',
                type: 'POST',
                data: {csrfmiddlewaretoken: window.CSRF_TOKEN},
                success: function (data) {
                    $('#subject-select').find('option').remove().end();
                    $.each(data, function (i, item) {
                        $('#subject-select').append($('<option>', {
                            value: item.id,
                            text: item.name
                        }));
                    });
                },
                error: function (request, status, error) {
                    console.log("Ajax Request Error - Status: " + status, " - Error: " + error);
                }
            });
        });

        var charCount = function (text_max, input, span) {
            $(span).html(0 + '/' + text_max);
            $(input).keyup(function () {
                var text_length = $(input).val().length;
                $(span).html(text_length + '/' + text_max);
            });
        };

        function aMemberNameEmpty() {
            var result = false;
            $('.pu-member-select2').each(function () {
                if ($(this).val() === "") {
                    result = true;
                    return false;
                }
            });
            return result;
        }

        $('#pu-add-member').on("click", function () {
            if (!aMemberNameEmpty()) {
                $.getJSON({% url 'member-choices-with-resp' %}, function (json) {
                    member_wrapper.append(json.text);
                    $(".pu-member-select2").select2({
                        containerCss: "pu-member-select2",
                        placeholder: "Mitglied wählen"
                    });

                    $(".resp-bar").tagit({
                        placeholderText: 'Tätigkeit hinzufügen',
                        autocomplete: {
                            source: [] //TODO: Get list of all tags from server
                        },
                        showAutocompleteOnFocus: true
                    });
                });
            }
        });

        function fillMemberResponsibilities() {
            users_responsibilities = {};
            var resp_arr = $('.resp-bar');
            $('.pu-member-select2').each(function (index, item) {
                users_responsibilities[$(this).val()] = $(resp_arr.get(index)).tagit("assignedTags");
            });

            users_responsibilities[{{ request.user.get_lib_user.id }}] =
                $("#resp-bar-{{ request.user.get_lib_user.id }}").tagit("assignedTags");
        }

        $('#pu-add-supervisor').on("click", function () {
            var selection = $('#sv-' + (supervisor_input_uid - 1) + " .profs-choices").val();
            console.log(selection);
            if (supervisor_input_uid == 0 || !(selection === "choose")) {
                $.getJSON({% url 'supervisor-choices' %}, function (json) {
                    supervisor_wrapper.append(
                        "<div class='form-group' id='sv-" + supervisor_input_uid + "'>" +
                        json.text +
                        "<span style='margin-left:8px;' class='sv-close fa fa-times-circle'></span></div>"
                    );

                    $('.profs-choices').select2({
                        containerCss: "prof-choices",
                        placeholder: "Betreuer wählen"
                    });
                    supervisor_input_uid += 1;
                });
            }
        });

        supervisor_wrapper.on("click", '.sv-close', function (event) {
            var surrounding_div_id = $(event.target).parent()[0].id;
            $('#' + surrounding_div_id).remove();
        });

        function getSupervisors() {
            var supervisors = [];
            $('.profs-choices').each(function (index, item) {
                if (item.value != "choose") {
                    supervisors.push(item.value);
                }
            });
            return supervisors
        }

        $('[id^=link]').find('.btn').on("click", function () {
            $(this).parent().hide();
            $(this).parent().next().removeClass("hidden");
        });

        $('.link-close').on("click", function () {
            $(this).parent().prev().show();
            $(this).parent().addClass("hidden");
            $(this).next().val("");
        });

        function getProjectLinks() {
            var p_links = [];
            $(".psocial input").each(function () {
                p_links.push($(this).val());
            });
            return p_links;
        }

        function buildVariableProjectContents() {
            var content = [];
            $('.add-content-text').each(function (i, obj) {
                var subheading = $(this).children().eq(0).val();
                var text = $(this).children().eq(1).val();
                content.push({
                    content_type: "TEXT",
                    subheading: subheading,
                    text: text
                });
            });

            $('.add-content-slideshow').each(function (i, obj) {
                content.push({
                    content_type: "SLIDESHOW",
                    subheading: $(this).children().eq(0).val(),
                });
            });

            var sound_urls = [];
            $('.add-content-audio').find('.soundcloud-input').each(function (i, obj) {
                sound_urls.push({
                    url: $(this).find('.audio-url').val(),
                    text: $(this).find('.audio-subheading').val()
                });
            });

            $('.add-content-audio').each(function (i, obj) {
                content.push({
                    content_type: "AUDIO",
                    subheading: $(this).find('.content-subheading').val(),
                    urls: sound_urls
                });
            });

            var video_urls = [];
             $('.add-content-video').find('.video-link-input').each(function (i, obj) {
                video_urls.push({
                    url: $(this).find('.video-url').val(),
                    text: $(this).find('.video-subheading').val()
                });
            });

             $('.add-content-video').each(function (i, obj) {
                content.push({
                    content_type: "VIDEO",
                    subheading: $(this).find('.content-subheading').val(),
                    urls: video_urls
                });
            });
            return {content: content};
        }

        function buildAudioLabels() {
            var audio_descriptions = {};
            $('.add-content-audio').find('[id^=filestyle]').each(function (i, obj) {
                audio_descriptions["audio[" + i + "]"] = $(this).next().next().val();
            });
            return audio_descriptions;
        }

        function buildVideoLabels(){
            var video_descriptions = {};
            $('.add-content-video').find('[id^=filestyle]').each(function (i, obj) {
                video_descriptions["video[" + i + "]"] = $(this).next().next().val();
            });
            return video_descriptions;
        }

        $('#pu-publish').on("click", function () {
            fillMemberResponsibilities();

            var project_json_dict = JSON.stringify({
                p_heading: $('#heading').val(),
                p_subheading: $('#subheading').val(),
                p_description: $('#description').val(),
                p_degree_program: $('#degreeprogram-select').val(),
                p_semesteryear: $('#semesteryear-select').val(),
                p_subject: $('#subject-select').val(),
                p_supervisors: getSupervisors(),
                p_member_responsibilities: users_responsibilities,
                p_project_tags: $("#add-tags-bar").tagit("assignedTags"),
                p_project_links: getProjectLinks(),
                p_contents: buildVariableProjectContents(),
                p_audio_labels: buildAudioLabels(),
                p_video_labels: buildVideoLabels()
            });

            var formData = new FormData();
            var $dropZone = $('.add-content-slideshow .dropzone');
            if ($dropZone.length) {
                $.each($('.dropzone')[0].dropzone.files, function (i, obj) {
                    formData.append("file[" + i + "]", obj);
                });
            }
            formData.append("csrfmiddlewaretoken", window.CSRF_TOKEN);
            formData.append("params", project_json_dict);

            $('.audio-input-container').find('[id^=filestyle]').each(function (i, obj) {
                formData.append("audio[" + i + "]", obj.files[0]);
            });

            $('.video-input-container').find('[id^=filestyle]').each(function (i, obj) {
                formData.append("video[" + i + "]", obj.files[0]);
            });

            $.ajax({
                url: "{% url 'new-project' %}",
                type: "POST",
                contentType: false,
                processData: false,
                data: formData,
                success: function (json) {
                    alert("success");
                }
            });
        });

        $(document).ready(function () {
            $.getJSON("{% url 'add-content-choose' %}", function (json) {
                addcontent = json.text;
            });

            $.getJSON("{% url 'add-content-choices' %}", function (json) {
                addcontentchoice = json.text;
            });

            $("#add-tags-bar").tagit({
                placeholderText: 'Hinzufügen',
                autocomplete: {
                    source: [] //TODO: Get list of all tags from server
                },
                showAutocompleteOnFocus: true
            });

            $("#resp-bar-{{ request.user.get_lib_user.id }}").tagit({
                placeholderText: 'Tätigkeit hinzufügen',
                autocomplete: {
                    source: [] //TODO: Get list of all tags from server
                },
                showAutocompleteOnFocus: true
            });
            $('#degreeprogram-select').trigger('change');
        });
    </script>
{% endblock %}